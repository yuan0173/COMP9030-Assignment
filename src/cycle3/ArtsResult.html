<!DOCTYPE html>
<html>
  <head>
    <title>ArtsResult - Indigenous Art Atlas</title>
    <link rel="stylesheet" href="../cycle2/css/base.css">
    <link rel="stylesheet" href="../cycle2/css/layout.css">
    <link rel="stylesheet" href="../cycle2/css/components.css">
    <link rel="stylesheet" href="../cycle2/css/pages.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  </head>
  <body>
    <!-- Header will be dynamically generated by header.js -->
    <div id="header-placeholder"></div>

    <!-- Main body -->
    <main class="container page-section">

      <section class="listings">
        <!-- Left side filter -->
        <aside class="filter">
          <h4>State</h4>
          <label><input id="filterStateNSW" type="checkbox" checked> NSW</label>
          <label><input id="filterStateVIC" type="checkbox" checked> VIC</label>
          <label><input id="filterStateSA" type="checkbox" checked> SA</label>
          <label><input id="filterStateQLD" type="checkbox" checked> QLD</label>
          <label><input id="filterStateWA" type="checkbox" checked> WA</label>
          <label><input id="filterStateTAS" type="checkbox" checked> TAS</label>
          <label><input id="filterStateNT" type="checkbox" checked> NT</label>
          <label><input id="filterStateACT" type="checkbox" checked> ACT</label>

          <h4 style="margin-top:12px;">Type</h4>
          <label><input id="filterTypeCave" type="checkbox" checked> Cave Art</label>
          <label><input id="filterTypeMural" type="checkbox" checked> Mural</label>

          <h4 style="margin-top:12px;">Periods</h4>
          <label><input id="filterPeriodAncient" type="checkbox" checked> Ancient</label>
          <label><input id="filterPeriodContemporary" type="checkbox" checked> Contemporary</label>
        </aside>

        <!-- Right side -->
        <section class="listings__main">
          <!-- Search and sort -->
          <div class="flex-between listings-toolbar">
            <div class="searchbar">
              <label class="visually-hidden" for="searchInput">Search arts</label>
              <input id="searchInput" class="input searchbar__input" placeholder="Search" />
              <button class="btn" aria-label="Search">üîç</button>
            </div>

            <div class="pills" aria-label="Sort">
              <button id="sortNew" class="pill pill--active">New</button>
              <button id="sortDateAsc" class="pill">Date ‚Üë</button>
              <button id="sortDateDesc" class="pill">Date ‚Üì</button>
              <button id="sortTitleAsc" class="pill">Title ‚Üë</button>
              <button id="sortTitleDesc" class="pill">Title ‚Üì</button>
            </div>
          </div>

          <!-- Map toggle and add new buttons -->
          <div class="flex-between" style="margin:16px 0;">
            <button id="mapToggle" class="btn btn--ghost">Show Map</button>
            <a href="/cycle2/Pages/Submission.html" class="btn">Add New Art</a>
          </div>

          <!-- Map Section (toggleable) -->
          <section id="mapSection" class="page-section" style="display:none;">
            <div id="resultsMap" class="map-box" style="height:400px;"></div>
          </section>

          <!-- Card container -->
          <div id="artsContainer" class="cards mt-4"></div>

          <!-- Pagination -->
          <nav class="pagination mt-4" aria-label="Pagination">
            <!-- Pagination will be dynamically generated by JavaScript -->
          </nav>
        </section>
      </section>

    </main>

    <!-- Footer -->
    <footer class="footer page-section">
      <div class="container flex-between">
        <div>¬© IAA</div>
        <nav>
          <a href="./About.html">Introduction</a> ¬∑
          <a href="./Guideline.html">Guidelines</a> ¬∑
          <a href="./ArtsResult.html" aria-current="page">Art Listings</a> ¬∑
          <a href="./Contact.html">Contact Us</a> ¬∑
          <a href="./Disclaimer.html">Disclaimers</a>
        </nav>
      </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="../cycle2/js/session.js"></script>
    <script src="../cycle2/js/header.js"></script>
    <script>
      // Enhanced arts listing functionality for cycle3 with cycle2 filtering logic
      (function(){
        var container = document.getElementById('artsContainer');
        if (!container) return;

        var cache = [];
        var currentSort = 'new';
        var currentPage = 1;
        var itemsPerPage = 6;
        var totalPages = 1;
        var currentQuery = '';
        var map = null;

        // Function to extract state from coordinates
        function getStateFromCoordinates(lat, lng) {
          if (typeof lat !== 'number' || typeof lng !== 'number') return null;

          // New South Wales
          if (lng >= 141 && lng <= 159 && lat >= -37.5 && lat <= -28.5) return 'nsw';

          // Queensland
          if (lng >= 138 && lng <= 154 && lat >= -29 && lat <= -9) return 'qld';

          // South Australia
          if (lng >= 129 && lng <= 141 && lat >= -38 && lat <= -26) return 'sa';

          // Western Australia
          if (lng >= 113 && lng <= 129 && lat >= -35 && lat <= -13) return 'wa';

          // Northern Territory
          if (lng >= 129 && lng <= 138 && lat >= -26 && lat <= -11) return 'nt';

          // Australian Capital Territory
          if (lng >= 148.7 && lng <= 149.3 && lat >= -35.9 && lat <= -35.1) return 'act';

          // Victoria
          if (lng >= 141 && lng <= 150 && lat >= -39 && lat < -34) return 'vic';

          // Tasmania
          if (lat < -39) return 'tas';

          return null;
        }

        function extractState(locationNotes, lat, lng) {
          if (typeof lat === 'number' && typeof lng === 'number') {
            return getStateFromCoordinates(lat, lng);
          }

          if (!locationNotes || locationNotes.trim() === '') return null;

          var note = locationNotes.toLowerCase().trim();

          if (note.includes('nsw') || note.includes('new south wales')) return 'nsw';
          if (note.includes('vic') || note.includes('victoria')) return 'vic';
          if (note.includes('qld') || note.includes('queensland')) return 'qld';
          if (note.includes('sa') || note.includes('south australia')) return 'sa';
          if (note.includes('wa') || note.includes('western australia')) return 'wa';
          if (note.includes('tas') || note.includes('tasmania')) return 'tas';
          if (note.includes('nt') || note.includes('northern territory')) return 'nt';
          if (note.includes('act') || note.includes('australian capital territory') || note.includes('canberra')) return 'act';

          return null;
        }

        function readFilters(){
          var typeCave = document.getElementById('filterTypeCave');
          var typeMural = document.getElementById('filterTypeMural');
          var periodAncient = document.getElementById('filterPeriodAncient');
          var periodContemporary = document.getElementById('filterPeriodContemporary');
          var stateNSW = document.getElementById('filterStateNSW');
          var stateVIC = document.getElementById('filterStateVIC');
          var stateSA = document.getElementById('filterStateSA');
          var stateQLD = document.getElementById('filterStateQLD');
          var stateWA = document.getElementById('filterStateWA');
          var stateTAS = document.getElementById('filterStateTAS');
          var stateNT = document.getElementById('filterStateNT');
          var stateACT = document.getElementById('filterStateACT');

          return {
            type: {
              cave: typeCave ? !!typeCave.checked : true,
              mural: typeMural ? !!typeMural.checked : true
            },
            period: {
              ancient: periodAncient ? !!periodAncient.checked : true,
              contemporary: periodContemporary ? !!periodContemporary.checked : true
            },
            state: {
              nsw: stateNSW ? !!stateNSW.checked : true,
              vic: stateVIC ? !!stateVIC.checked : true,
              sa: stateSA ? !!stateSA.checked : true,
              qld: stateQLD ? !!stateQLD.checked : true,
              wa: stateWA ? !!stateWA.checked : true,
              tas: stateTAS ? !!stateTAS.checked : true,
              nt: stateNT ? !!stateNT.checked : true,
              act: stateACT ? !!stateACT.checked : true
            }
          };
        }

        function sortArts(list) {
          if (!Array.isArray(list)) return list;

          var sorted = list.slice();

          switch(currentSort) {
            case 'new':
              sorted.sort(function(a, b) {
                var dateA = new Date(a.createdAt || 0);
                var dateB = new Date(b.createdAt || 0);
                return dateB - dateA;
              });
              break;
            case 'date-asc':
              sorted.sort(function(a, b) {
                var dateA = new Date(a.createdAt || 0);
                var dateB = new Date(b.createdAt || 0);
                return dateA - dateB;
              });
              break;
            case 'date-desc':
              sorted.sort(function(a, b) {
                var dateA = new Date(a.createdAt || 0);
                var dateB = new Date(b.createdAt || 0);
                return dateB - dateA;
              });
              break;
            case 'title-asc':
              sorted.sort(function(a, b) {
                return (a.title || '').localeCompare(b.title || '');
              });
              break;
            case 'title-desc':
              sorted.sort(function(a, b) {
                return (b.title || '').localeCompare(a.title || '');
              });
              break;
          }

          return sorted;
        }

        function filterArts(list) {
          if (!Array.isArray(list)) return [];

          var filters = readFilters();

          return list.filter(function(item) {
            // Search query filter
            if (currentQuery.trim() !== '') {
              var query = currentQuery.toLowerCase();
              var title = (item.title || '').toLowerCase();
              var desc = (item.description || '').toLowerCase();
              if (!title.includes(query) && !desc.includes(query)) {
                return false;
              }
            }

            // Type filter
            var itemType = (item.type || '').toLowerCase();
            if (itemType === 'cave art' && !filters.type.cave) return false;
            if (itemType === 'mural' && !filters.type.mural) return false;

            // Period filter
            var itemPeriod = (item.period || '').toLowerCase();
            if (itemPeriod === 'ancient' && !filters.period.ancient) return false;
            if (itemPeriod === 'contemporary' && !filters.period.contemporary) return false;

            // State filter
            var itemState = extractState(item.locationNotes, parseFloat(item.lat), parseFloat(item.lng));
            if (itemState) {
              if (itemState === 'nsw' && !filters.state.nsw) return false;
              if (itemState === 'vic' && !filters.state.vic) return false;
              if (itemState === 'sa' && !filters.state.sa) return false;
              if (itemState === 'qld' && !filters.state.qld) return false;
              if (itemState === 'wa' && !filters.state.wa) return false;
              if (itemState === 'tas' && !filters.state.tas) return false;
              if (itemState === 'nt' && !filters.state.nt) return false;
              if (itemState === 'act' && !filters.state.act) return false;
            }

            return true;
          });
        }

        function createCard(item) {
          var card = document.createElement('a');
          card.className = 'card';
          card.href = './art_detail.php?id=' + encodeURIComponent(item.id);

          var imgWrap = document.createElement('div');
          imgWrap.className = 'card__img';
          var img = document.createElement('img');
          img.src = item.image || '../test.jpg';
          img.alt = item.title || 'Artwork';
          imgWrap.appendChild(img);

          var body = document.createElement('div');
          body.className = 'card__body';
          var h3 = document.createElement('h3');
          h3.className = 'card__title';
          h3.textContent = item.title || 'Untitled';
          var p = document.createElement('p');
          p.className = 'card__desc';
          p.textContent = item.description || '';
          body.appendChild(h3);
          body.appendChild(p);

          // Author meta (username and role) if provided by API
          try {
            var username = item.author_username ? ('@' + item.author_username) : '';
            var role = item.author_role ? String(item.author_role) : '';
            if (role) { role = role.charAt(0).toUpperCase() + role.slice(1); }
            var metaText = [username, role].filter(Boolean).join(' ‚Ä¢ ');
            if (metaText) {
              var meta = document.createElement('div');
              meta.className = 'card__desc';
              meta.textContent = metaText;
              body.appendChild(meta);
            }
          } catch(_) {}

          card.appendChild(imgWrap);
          card.appendChild(body);
          return card;
        }

        function renderList() {
          var filtered = filterArts(cache);
          var sorted = sortArts(filtered);

          totalPages = Math.ceil(sorted.length / itemsPerPage);
          if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
          }

          var startIdx = (currentPage - 1) * itemsPerPage;
          var endIdx = startIdx + itemsPerPage;
          var pageItems = sorted.slice(startIdx, endIdx);

          container.innerHTML = '';
          pageItems.forEach(function(item) {
            container.appendChild(createCard(item));
          });

          updatePagination();
          updateMap(sorted);
        }

        function updatePagination() {
          var paginationEl = document.querySelector('.pagination');
          if (!paginationEl) return;

          if (totalPages <= 1) {
            paginationEl.style.display = 'none';
            return;
          }

          paginationEl.style.display = 'flex';
          paginationEl.innerHTML = '';

          // Previous button
          var prevBtn = document.createElement('button');
          prevBtn.className = 'btn btn--ghost';
          prevBtn.innerHTML = '&larr; Previous';
          prevBtn.disabled = currentPage === 1;
          prevBtn.addEventListener('click', function() {
            if (currentPage > 1) {
              currentPage--;
              renderList();
            }
          });
          paginationEl.appendChild(prevBtn);

          // Page info
          var pageInfo = document.createElement('span');
          pageInfo.textContent = 'Page ' + currentPage + ' of ' + totalPages;
          paginationEl.appendChild(pageInfo);

          // Next button
          var nextBtn = document.createElement('button');
          nextBtn.className = 'btn btn--ghost';
          nextBtn.innerHTML = 'Next &rarr;';
          nextBtn.disabled = currentPage === totalPages;
          nextBtn.addEventListener('click', function() {
            if (currentPage < totalPages) {
              currentPage++;
              renderList();
            }
          });
          paginationEl.appendChild(nextBtn);
        }

        function initMap() {
          if (!window.L) return;

          var mapEl = document.getElementById('resultsMap');
          if (!mapEl) return;

          map = L.map('resultsMap', { center: [-33.8688, 151.2093], zoom: 6 });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
        }

        function updateMap(arts) {
          if (!map) return;

          // Clear existing markers
          map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });

          // Add markers for current results
          arts.forEach(function(art) {
            if (art.lat && art.lng) {
              var lat = parseFloat(art.lat);
              var lng = parseFloat(art.lng);
              if (!isNaN(lat) && !isNaN(lng)) {
                L.marker([lat, lng])
                  .bindPopup('<strong>' + art.title + '</strong><br>' +
                           art.type + ' - ' + art.period + '<br>' +
                           '<a href="./art_detail.php?id=' + art.id + '">View Details</a>')
                  .addTo(map);
              }
            }
          });
        }

        // Event listeners
        function setupEventListeners() {
          // Search
          var searchInput = document.getElementById('searchInput');
          if (searchInput) {
            searchInput.addEventListener('input', function() {
              currentQuery = this.value;
              currentPage = 1;
              renderList();
            });
          }

          // Sort buttons
          document.getElementById('sortNew').addEventListener('click', function() {
            currentSort = 'new';
            updateSortButtons(this);
            renderList();
          });

          document.getElementById('sortDateAsc').addEventListener('click', function() {
            currentSort = 'date-asc';
            updateSortButtons(this);
            renderList();
          });

          document.getElementById('sortDateDesc').addEventListener('click', function() {
            currentSort = 'date-desc';
            updateSortButtons(this);
            renderList();
          });

          document.getElementById('sortTitleAsc').addEventListener('click', function() {
            currentSort = 'title-asc';
            updateSortButtons(this);
            renderList();
          });

          document.getElementById('sortTitleDesc').addEventListener('click', function() {
            currentSort = 'title-desc';
            updateSortButtons(this);
            renderList();
          });

          // Filter checkboxes
          var filterIds = [
            'filterStateNSW', 'filterStateVIC', 'filterStateSA', 'filterStateQLD',
            'filterStateWA', 'filterStateTAS', 'filterStateNT', 'filterStateACT',
            'filterTypeCave', 'filterTypeMural',
            'filterPeriodAncient', 'filterPeriodContemporary'
          ];

          filterIds.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) {
              el.addEventListener('change', function() {
                currentPage = 1;
                renderList();
              });
            }
          });

          // Map toggle
          var mapToggle = document.getElementById('mapToggle');
          var mapSection = document.getElementById('mapSection');
          if (mapToggle && mapSection) {
            mapToggle.addEventListener('click', function() {
              if (mapSection.style.display === 'none') {
                mapSection.style.display = 'block';
                mapToggle.textContent = 'Hide Map';
                if (!map) {
                  initMap();
                } else {
                  map.invalidateSize();
                }
                updateMap(filterArts(cache));
              } else {
                mapSection.style.display = 'none';
                mapToggle.textContent = 'Show Map';
              }
            });
          }
        }

        function updateSortButtons(activeBtn) {
          document.querySelectorAll('.pill').forEach(function(btn) {
            btn.classList.remove('pill--active');
          });
          activeBtn.classList.add('pill--active');
        }

        function loadAllArts() {
          fetch('/api/arts.php')
            .then(function(response) {
              if (!response.ok) {
                throw new Error('API request failed: ' + response.status);
              }
              return response.json();
            })
            .then(function(data) {
              cache = data;
              renderList();
            })
            .catch(function(err) {
              console.error('Failed to load arts:', err);
              container.innerHTML = '<div class="notice notice--error">Failed to load artworks. Please try again later.</div>';
            });
        }

        // Initialize
        setupEventListeners();
        loadAllArts();
      })();
    </script>
  </body>
</html>
