<!DOCTYPE html>
<html>
  <head>
    <title>Submit Artwork - Indigenous Art Atlas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="../cycle2/css/base.css">
    <link rel="stylesheet" href="../cycle2/css/layout.css">
    <link rel="stylesheet" href="../cycle2/css/components.css">
    <link rel="stylesheet" href="../cycle2/css/pages.css">
  </head>
  <body>
    <script>
      // Redirect to the unified submission page to avoid duplicate flows
      try { window.location.replace('/cycle2/Pages/Submission.html'); } catch(_) {}
    </script>
    <!-- Header will be dynamically generated by header.js -->
    <div id="header-placeholder"></div>

    <main class="container page-section">
      <h1>Submit New Artwork</h1>

      <div class="grid" style="gap: 32px; align-items: start;">
        <div>
          <div class="card" style="padding: 24px;">
            <h2 style="margin-top: 0;">Artwork Information</h2>

            <form id="submissionForm" class="form" enctype="multipart/form-data">
              <div class="form__row">
                <input id="artTitle" class="input" type="text" placeholder="Artwork Title" required>
                <select id="artType" class="input" required>
                  <option value="">Select Type</option>
                  <option value="Cave Art">Cave Art</option>
                  <option value="Mural">Mural</option>
                  <option value="Sculpture">Sculpture</option>
                  <option value="Petroglyph">Petroglyph</option>
                  <option value="Painting">Painting</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="form__row">
                <select id="artPeriod" class="input" required>
                  <option value="">Select Period</option>
                  <option value="Ancient">Ancient</option>
                  <option value="Traditional">Traditional</option>
                  <option value="Contemporary">Contemporary</option>
                  <option value="Modern">Modern</option>
                  <option value="Unknown">Unknown</option>
                </select>
                <select id="artCondition" class="input" required>
                  <option value="">Current Condition</option>
                  <option value="Excellent">Excellent</option>
                  <option value="Good">Good</option>
                  <option value="Fair">Fair</option>
                  <option value="Poor">Poor</option>
                  <option value="Deteriorating">Deteriorating</option>
                </select>
              </div>

              <div>
                <label>Description</label>
                <textarea id="artDescription" class="input" rows="4" placeholder="Describe the artwork, its cultural significance, and any relevant details..." required></textarea>
                <div class="form__hint">Be mindful of cultural sensitivity and provide context when possible.</div>
              </div>

              <div>
                <label>Image Upload</label>
                <input id="artImage" class="input" type="file" accept="image/*" multiple>
                <div class="form__hint">Upload high-quality images. Multiple images can be selected.</div>
              </div>

              <h3>Location Information</h3>

              <div class="form__row">
                <input id="artLat" class="input" type="number" step="any" placeholder="Latitude">
                <input id="artLng" class="input" type="number" step="any" placeholder="Longitude">
                <button id="getCurrentLocation" type="button" class="btn btn--ghost">Use Current Location</button>
              </div>

              <div>
                <label>Location Notes</label>
                <textarea id="artLocationNotes" class="input" rows="3" placeholder="Describe the location, access information, or any relevant details..."></textarea>
                <div class="form__hint">Include accessibility information and any restrictions.</div>
              </div>

              <h3>Privacy and Permissions</h3>

              <div class="form__row">
                <label>
                  <input id="artCreditArtist" type="checkbox">
                  This artwork has a known/credited artist
                </label>
              </div>

              <div class="form__row">
                <label>
                  <input id="artSensitive" type="checkbox">
                  This artwork is culturally sensitive or sacred
                </label>
              </div>

              <div class="form__row">
                <label>
                  <input id="artPrivateLand" type="checkbox">
                  This artwork is located on private land
                </label>
              </div>

              <div class="form__row">
                <label>
                  <input id="artPermission" type="checkbox" required>
                  I have permission to document and share this artwork
                </label>
              </div>

              <div class="form__actions">
                <button type="submit" class="btn">Submit Artwork</button>
                <button type="reset" class="btn btn--ghost">Reset Form</button>
              </div>
            </form>

            <div id="submissionSuccess" class="notice notice--success" style="display: none; margin-top: 16px;">
              Artwork submitted successfully! Thank you for contributing to the Indigenous Art Atlas.
            </div>

            <div id="submissionError" class="notice notice--error" style="display: none; margin-top: 16px;">
              <span id="errorMessage">There was an error submitting your artwork. Please try again.</span>
            </div>
          </div>
        </div>

        <div>
          <div class="card" style="padding: 24px; margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Location Preview</h3>
            <div id="locationMap" class="map-box" style="height: 300px;"></div>
            <p class="form__hint" style="margin-top: 8px;">Click on the map to set coordinates, or use the "Current Location" button.</p>
          </div>

          <div class="card" style="padding: 24px;">
            <h3 style="margin-top: 0;">Submission Guidelines</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li>Ensure you have proper permissions before documenting artwork</li>
              <li>Respect cultural protocols and sacred sites</li>
              <li>Provide accurate location information when appropriate</li>
              <li>Use high-quality, clear photographs</li>
              <li>Include cultural context and significance when known</li>
              <li>Mark sensitive or private locations appropriately</li>
            </ul>
            <a href="./Guideline.html" class="btn btn--ghost" style="margin-top: 12px;">Read Full Guidelines</a>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container flex-between">
        <div>© IAA</div>
        <nav>
          <a href="./Home.html">Home</a> ·
          <a href="./About.html">About</a> ·
          <a href="./Guideline.html">Guidelines</a> ·
          <a href="./ArtsResult.html">Art Listings</a> ·
          <a href="./Contact.html">Contact Us</a> ·
          <a href="./Disclaimer.html">Disclaimers</a>
        </nav>
      </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="../cycle2/js/session.js"></script>
    <script src="../cycle2/js/header.js"></script>
    <script>
      // Enhanced submission functionality for cycle3
      (function(){
        var map = null;
        var marker = null;

        // Initialize map
        function initMap() {
          if (!window.L) return;

          var mapEl = document.getElementById('locationMap');
          if (!mapEl) return;

          map = L.map('locationMap', { center: [-33.8688, 151.2093], zoom: 10 });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          // Allow clicking on map to set location
          map.on('click', function(e) {
            setLocation(e.latlng.lat, e.latlng.lng);
          });
        }

        // Set location on map and in form
        function setLocation(lat, lng) {
          document.getElementById('artLat').value = lat.toFixed(6);
          document.getElementById('artLng').value = lng.toFixed(6);

          if (marker) {
            map.removeLayer(marker);
          }

          marker = L.marker([lat, lng]).addTo(map);
          map.setView([lat, lng], 14);
        }

        // Get current location
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by this browser.');
            return;
          }

          navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            setLocation(lat, lng);
          }, function(error) {
            alert('Error getting location: ' + error.message);
          });
        });

        // Handle form submission
        document.getElementById('submissionForm').addEventListener('submit', function(e) {
          e.preventDefault();

          var formData = new FormData();

          // Basic artwork data
          formData.append('title', document.getElementById('artTitle').value.trim());
          formData.append('type', document.getElementById('artType').value);
          formData.append('period', document.getElementById('artPeriod').value);
          formData.append('condition', document.getElementById('artCondition').value);
          formData.append('description', document.getElementById('artDescription').value.trim());
          formData.append('locationNotes', document.getElementById('artLocationNotes').value.trim());

          // Location data
          var lat = document.getElementById('artLat').value;
          var lng = document.getElementById('artLng').value;
          if (lat) formData.append('lat', parseFloat(lat));
          if (lng) formData.append('lng', parseFloat(lng));

          // Checkboxes
          formData.append('creditKnownArtist', document.getElementById('artCreditArtist').checked);
          formData.append('sensitive', document.getElementById('artSensitive').checked);
          formData.append('privateLand', document.getElementById('artPrivateLand').checked);

          // Handle file uploads
          var fileInput = document.getElementById('artImage');
          if (fileInput.files.length > 0) {
            for (var i = 0; i < fileInput.files.length; i++) {
              formData.append('images[]', fileInput.files[i]);
            }
          }

          // Submit to API
          fetch('/api/arts.php', {
            method: 'POST',
            body: formData
          })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Submission failed: ' + response.status);
            }
            return response.json();
          })
          .then(function(data) {
            // Show success message
            document.getElementById('submissionSuccess').style.display = 'block';
            document.getElementById('submissionError').style.display = 'none';

            // Reset form
            document.getElementById('submissionForm').reset();
            if (marker) {
              map.removeLayer(marker);
              marker = null;
            }

            // Scroll to success message
            document.getElementById('submissionSuccess').scrollIntoView({ behavior: 'smooth' });

            // Optionally redirect to the new artwork after a delay
            setTimeout(function() {
              if (data.id) {
                window.location.href = './art_detail.php?id=' + data.id;
              }
            }, 3000);
          })
          .catch(function(error) {
            if (window.console && console.error) {
              console.error('Submission error:', error);
            }
            document.getElementById('submissionError').style.display = 'block';
            document.getElementById('submissionSuccess').style.display = 'none';
            document.getElementById('errorMessage').textContent = error.message;
          });
        });

        // Update coordinates when manually entered
        document.getElementById('artLat').addEventListener('input', updateMapFromCoords);
        document.getElementById('artLng').addEventListener('input', updateMapFromCoords);

        function updateMapFromCoords() {
          var lat = parseFloat(document.getElementById('artLat').value);
          var lng = parseFloat(document.getElementById('artLng').value);

          if (!isNaN(lat) && !isNaN(lng)) {
            if (marker) {
              map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 14);
          }
        }

        // Initialize when page loads
        try {
          initMap();
        } catch (e) {
          if (window.console && console.error) {
            console.error('Failed to initialize submission page:', e);
          }
        }
      })();
    </script>
  </body>
</html>
